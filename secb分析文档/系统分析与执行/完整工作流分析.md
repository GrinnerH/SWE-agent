# SWE-agent SEC-bench 完整工作流分析

## 📋 目录
1. [概述](#概述)
2. [架构层次](#架构层次)
3. [脚本层：run_secb.sh](#脚本层runseсbsh)
4. [配置层：YAML 配置文件](#配置层yaml-配置文件)
5. [执行层：SWE-agent 核心](#执行层swe-agent-核心)
6. [工具层：Tools Bundles](#工具层tools-bundles)
7. [环境层：容器化执行](#环境层容器化执行)
8. [完整执行流程](#完整执行流程)
9. [数据流向](#数据流向)
10. [关键配置参数](#关键配置参数)

---

## 概述

`run_secb.sh` 是一个包装脚本，用于简化在 SEC-bench 数据集上运行 SWE-agent 的流程。它支持两种安全任务模式：

- **PoC 模式**：生成漏洞利用的概念验证代码
- **Patch 模式**：生成修复漏洞的补丁

整个系统通过多层架构协同工作，将高层的用户意图转换为具体的代码执行和结果输出。

---

## 架构层次

```
┌─────────────────────────────────────────────────────────────┐
│                    用户接口层                                │
│                  run_secb.sh 脚本                            │
│           (简化命令行参数，模型映射)                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                    配置层                                    │
│         secb_poc.yaml / secb_patch.yaml                      │
│    (定义 Agent 行为、Prompt 模板、工具配置)                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                 执行调度层                                   │
│              sweagent run-batch                              │
│       (批量处理、并行调度、进度管理)                          │
└─────────────────────���┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                   Agent 层                                   │
│           AgentConfig + Model Interface                      │
│         (LLM 交互、历史管理、动作采样)                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                  工具执行层                                  │
│      Tools Bundles (defaults/search/change/submit)           │
│          (文件操作、搜索、编辑、提交)                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                  环境隔离层                                  │
│            SWE-ReX + Docker Container                        │
│          (隔离执行环境、状态管理)                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 脚本层：run_secb.sh

### 核心功能

`run_secb.sh` 作为用户友好的入口点，提供以下功能：

#### 1. **参数解析与验证**

```bash
# 模式选择
mode="poc" | "patch"

# 可配置参数
-m MODEL      # 模型名称（sonnet, 4o, deepseek 等）
-c COST       # 成本限制（默认 1.5）
-e TEMP       # 温度（默认 0.0）
-s SPLIT      # 数据集分割（默认 eval）
-l SLICE      # 实例切片（默认 :80）
-n CALLS      # 调用次数限制（默认 75）
-w WORKERS    # 并行 Worker 数量（默认 1）
-b API_BASE   # API 基础 URL（可选）
```

#### 2. **模型名称映射**

将简短的模型名称映射到完整的 LiteLLM 格式：

```bash
"sonnet"     → "anthropic/claude-3-7-sonnet-20250219"
"4o"         → "gpt-4o"
"deepseek"   → "openai/deepseek-chat"
"gemini-pro" → "gemini/gemini-2.5-pro-preview-03-25"
```

**设计优势**：
- 用户友好：简化命令行输入
- 灵活性��支持多种 LLM 提供商
- 可扩展：易于添加新模型

#### 3. **配置文件路由**

根据模式选择对应的配置文件：

```bash
poc   → config/secb_poc.yaml    (type=secb_poc)
patch → config/secb_patch.yaml  (type=secb_patch)
```

#### 4. **命令构建与执行**

最终构建并执行 `sweagent run-batch` 命令：

```bash
sweagent run-batch \
    --num_workers $workers \
    --config $config \
    --agent.model.name $model_name \
    --agent.model.temperature $temperature \
    --agent.model.top_p 0.95 \
    --agent.model.per_instance_call_limit $call_limit \
    --agent.model.per_instance_cost_limit $cost_limit \
    --agent.model.delay 1.0 \
    --instances.type $type \
    --instances.dataset_name "SEC-bench/SEC-bench" \
    --instances.split $split \
    --instances.slice $slice \
    --instances.shuffle=False
```

**关键参数说明**：
- `--num_workers`: 并行处理实例的数量
- `--config`: 指定 Agent 行为配置文件
- `--agent.model.*`: LLM 模型相关配置
- `--instances.*`: 数据集和实例选择配置

---

## 配置层：YAML 配置文件

配置文件定义了 Agent 的行为、工具和 Prompt 模板。

### secb_poc.yaml（PoC 生成模式）

#### 1. **Prompt 模板结构**

```yaml
agent:
  templates:
    system_template: "You are a helpful assistant..."
    instance_template: "{{problem_statement}} ..."
    next_step_template: "{{observation}} ..."
```

**三层 Prompt 设计**：

- **system_template**: 定义 Agent 的角色和能��
- **instance_template**: 首次交互的任务描述
- **next_step_template**: 后续交互的上下文格式

#### 2. **PoC 生成工作流（5 步骤）**

```
1. EXPLORATION（探索）
   ├─ 使用 find/grep 探索代码库结构
   ├─ 定位漏洞相关文件
   └─ 理解依赖关系

2. ANALYSIS（分析）
   ├─ 分析漏洞根本原因
   ├─ 确定触发路径
   └─ 设计输入数据

3. POC DEVELOPMENT（开发）
   ├─ 使用 secb build 编译项目
   ├─ 编写 Python 脚本（推荐）
   ├─ 保存到 /testcase 目录
   └─ 可使用 GDB 调试

4. VERIFICATION（验证）
   ├─ 运行 secb repro 测试
   ├─ 检查 sanitizer 输出
   └─ 记录行为

5. POC REFINEMENT（优化）
   ├─ 分析失败原因
   ├─ 调整 PoC 代码
   └─ 重复验证
```

#### 3. **工具配置**

```yaml
tools:
  execution_timeout: 300          # 命令执行超时时间
  env_variables:
    WINDOW: 100                   # 文件窗口大小
    OVERLAP: 2                    # 窗口重叠行数
  bundles:
    - path: tools/registry        # 状态管理
    - path: tools/defaults        # 文件导航/查看
    - path: tools/search          # 搜索功能
    - path: tools/change          # 文件编辑
    - path: tools/submit_poc      # PoC 提交
  enable_bash_tool: true          # 允许执行 bash 命令
  parse_function:
    type: function_calling        # 使用函数调用解析动作
```

#### 4. **历史处理器**

```yaml
history_processors:
  - type: last_n_observations
    n: 5                          # 保留最近 5 轮观察
```

**作用**：限制上下文长度，防止超出 token 限制

### secb_patch.yaml（补丁生成模式）

与 PoC 模式类似，但工作流不同：

```
1. EXPLORATION（探索）
   └─ 同 PoC 模式

2. ANALYSIS（分析）
   ├─ 提出 2-3 种修复方案
   ├─ 评估权衡
   └─ 选择最佳方案

3. IMPLEMENTATION（实现）
   ├─ 最小化修改
   ├─ 确保不引入新问题
   └─ 只修改非测试文件

4. VERIFICATION（验证）
   ├─ secb build 检查编译
   ├─ secb repro 验证修复
   └─ 必要时修订

5. FINAL REVIEW（最终审查）
   ├─ 重新审查漏洞描述
   ├─ 确认完全修复
   └─ 检查副作用
```

**关键差异**：
- 使用 `tools/submit_patch` 而不是 `tools/submit_poc`
- 强调最小化修改和不破坏现有功能
- 需要生成 git diff 格式的补丁

---

## 执行层：SWE-agent 核心

### RunBatchConfig 类

位于 `sweagent/run/run_batch.py`，核心配置类：

```python
class RunBatchConfig(BaseSettings):
    instances: BatchInstanceSourceConfig  # 实例来源配置
    agent: AgentConfig                    # Agent 配置
    output_dir: Path                      # 输出目录
    num_workers: int = 1                  # 并行 worker 数量
    raise_exceptions: bool = False        # 是否抛出异常
    redo_existing: bool = False           # 是否重做已有实例
    progress_bar: bool = True             # 是否显示进度条
```

### 批量处理流程

```python
def run_batch():
    # 1. 加载实例
    instances = load_instances_from_config(config.instances)

    # 2. 过滤/切片/打乱
    instances = filter_instances(instances, config)

    # 3. 设置输出目录
    output_dir = setup_output_dir(config)

    # 4. 创建线程池
    with ThreadPoolExecutor(max_workers=config.num_workers) as executor:
        # 5. 提交任务
        futures = [
            executor.submit(run_single_instance, instance, config)
            for instance in instances
        ]

        # 6. 收集结果
        for future in as_completed(futures):
            result = future.result()
            save_trajectory(result, output_dir)

    # 7. 合并预测结果
    merge_predictions(output_dir)
```

### 单实例执行流程

```python
def run_single_instance(instance, config):
    # 1. 创建隔离环境
    env = SWEEnv(instance, config)

    # 2. 初始化 Agent
    agent = get_agent_from_config(config.agent)

    # 3. 运行 Agent
    result = agent.run(env, instance)

    # 4. 返回结果
    return result
```

---

## 工具层：Tools Bundles

每个 tool bundle 是一个独立模块，提供特定功能。

### 1. tools/defaults（基础工具）

**功能**：文件导航和查看

```bash
open <file>           # 打开文件（窗口化查看）
goto <line>           # 跳转到指定行
scroll_up             # 向上滚动
scroll_down           # 向下滚动
create <file>         # 创建新文件
```

**实现**：基于 Python 的 `windowed_file.py`

- 维护文件的窗口视图
- 避免一次性加载整个文件
- 支持大文件浏览

### 2. tools/search（搜索工具）

**功能**：代码搜索

```bash
find_file <pattern>              # 按名称查找文件
search_dir <pattern> [dir]       # 在目录中搜索内容
search_file <pattern> <file>     # 在文件中搜索
```

**实现**：包装 Unix 工具

- `find`: 文件名搜索
- `grep`: 内容搜索

### 3. tools/change（编辑工具）

**功能**：文件编辑

```bash
edit <file>:<start_line>-<end_line>
new_content
<<<<<<< DIVIDER >>>>>>>
```

**实现**：基于行范围的替换

- 精确的行号定位
- 支持多行编辑
- 自动语法检查（可选）

### 4. tools/submit_poc（PoC 提交）

**功能**：打包并提交 PoC

```bash
submit
```

**实现流程**：

```bash
# 1. 压缩 /testcase 目录
tar -czf poc.tar.gz /testcase/*

# 2. Base64 编码
base64 poc.tar.gz > poc.tar.gz.base64

# 3. 输出提交标记
echo "<<SWE_AGENT_SUBMISSION>>"
cat poc.tar.gz.base64
echo "<<SWE_AGENT_SUBMISSION>>"
```

### 5. tools/submit_patch（补丁提交）

**功能**：生成并提交 git patch

```bash
submit <base_dir>
```

**实现流程**：

```bash
# 1. 暂存所有更改
git add -A

# 2. 生成 diff
git diff --cached > model.patch

# 3. 输出提交标记
echo "<<SWE_AGENT_SUBMISSION>>"
cat model.patch
echo "<<SWE_AGENT_SUBMISSION>>"
```

---

## 环境层：容器化执行

### SWE-ReX 架构

SWE-agent 使用 SWE-ReX（SWE-agent Runtime EXecution）提供隔离环境。

```
┌────────────────────────────────────────────┐
│           Host System (Python)              │
│   ┌────────────────────────────────────┐   │
│   │      SWE-agent Process             │   │
│   │  ┌──────────────────────────────┐  │   │
│   │  │    SWEEnv Interface          │  │   │
│   │  │  (Python API)                │  │   │
│   │  └─────────────┬────────────────┘  │   │
│   │                │ HTTP/gRPC         │   │
│   └────────────────┼───────────────────┘   │
│                    │                        │
└────────────────────┼────────────────────────┘
                     │
┌────────────────────▼────────────────────────┐
│      Docker Container (Isolated)            │
│   ┌────────────────────────────────────┐   │
│   │    SWE-ReX Runtime Server          │   │
│   │  ┌──────────────────────────────┐  │   │
│   │  │   Command Executor           │  │   │
│   │  │  (bash, tools, etc.)         │  │   │
│   │  └──────────────────────────────┘  │   │
│   │  ┌──────────────────────────────┐  │   │
│   │  │   File System                │  │   │
│   │  │  - /workspace (repo)         │  │   │
│   │  │  - /testcase (artifacts)     │  │   │
│   │  └──────────────────────────────┘  │   │
│   └────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### 环境隔离优势

1. **安全性**：恶意代码无法影响主机
2. **可重复性**：每个实例独立环境
3. **并行性**：多容器并行执行
4. **清理**：容器销毁自动清理

### 环境初始化

```python
# 1. 拉取 Docker 镜像
docker.pull("sweagent/swe-agent:latest")

# 2. 创建容器
container = docker.run(
    image="sweagent/swe-agent:latest",
    volumes={
        workspace: "/workspace",
        testcase: "/testcase"
    },
    environment={
        "INSTANCE_ID": instance_id,
    }
)

# 3. 克隆代码库
env.execute("git clone {repo_url} /workspace")
env.execute("cd /workspace && git checkout {commit}")

# 4. 安装依赖
env.execute("secb build")
```

---

## 完整执行流程

### 端到端示例：PoC 生成

```bash
# 用户命令
./run_secb.sh poc -m deepseek -l :5
```

#### 阶段 1：脚本处理（run_secb.sh）

```
输入：poc -m deepseek -l :5
↓
解析参数：
  - mode = poc
  - model = deepseek
  - slice = :5
↓
模型映射：
  - model_name = openai/deepseek-chat
  - api_base = https://www.dmxapi.cn/v1
↓
配置选择：
  - config = config/secb_poc.yaml
  - type = secb_poc
↓
构建命令：
  sweagent run-batch \
    --config config/secb_poc.yaml \
    --agent.model.name openai/deepseek-chat \
    --agent.model.api_base https://www.dmxapi.cn/v1 \
    --instances.type secb_poc \
    --instances.slice :5 \
    ...
```

#### 阶段 2：实例加载（BatchInstanceLoader）

```
加载数据集：SEC-bench/SEC-bench
↓
过滤实例：type=secb_poc, split=eval
↓
切片：取前 5 个实例
↓
返回实例列表：
  - Instance 1: CVE-2021-XXXX
  - Instance 2: CVE-2021-YYYY
  - ...
  - Instance 5: CVE-2021-ZZZZ
```

#### 阶段 3：并行调度（ThreadPoolExecutor）

```
创建线程池（num_workers=1）
↓
提交任务：
  - Task 1: run_instance(Instance 1)
  - Task 2: run_instance(Instance 2)
  - ...
  - Task 5: run_instance(Instance 5)
↓
等待完成，收集结果
```

#### 阶段 4：单实例执行（以 Instance 1 为例）

```
1. 环境准备
   ├─ 创建 Docker 容器
   ├─ 克隆代码库到 /workspace
   └─ 检出指定 commit

2. Agent 初始化
   ├─ 加载 secb_poc.yaml 配置
   ├─ 初始化 DeepSeek 模型
   └─ 设置工具（defaults, search, change, submit_poc）

3. 首次交互
   ├─ 渲染 instance_template
   │  ├─ 插入 {{problem_statement}}（漏洞描述）
   │  └─ 生成初始 prompt
   ├─ 发送到 DeepSeek API
   └─ 接收 Agent 动作（JSON）

4. 执行循环（最多 75 次）
   Loop:
     ├─ 解析 Agent 动作
     │  └─ 例如：{"tool": "search_file", "args": {"pattern": "CVE", "file": "main.c"}}
     ├─ 执行动作（在容器中）
     │  └─ 调用 tools/search/bin/search_file
     ├─ 获取观察结果
     │  └─ 例如：Found 3 matches in main.c
     ├─ 渲染 next_step_template
     │  ├─ 插入 {{observation}}
     │  └─ 更新当前状态
     ├─ 发送到 LLM
     └─ 接收下一个动作
   Until:
     - Agent 调用 submit 命令
     - 达到调用次数限制（75）
     - 达到成本限制（$1.5）
     - 遇到错误

5. 提交阶段
   ├─ Agent 执行 submit 命令
   ├─ 运行 tools/submit_poc/bin/submit
   │  ├─ 压缩 /testcase 目录
   │  ├─ Base64 编码
   │  └─ 输出提交标记
   ├─ SWE-agent 捕获提交内容
   └─ 保存到 output_dir/instance_1.traj

6. 清理
   ├─ 保存轨迹文件
   ├─ 销毁 Docker 容器
   └─ 释放资源
```

#### 阶段 5：结果汇总

```
等待所有实例完成
↓
合并预测结果（merge_predictions）
  ├─ 读取所有 .traj 文件
  ├─ 提取提交内容
  └─ 生成 predictions.jsonl
↓
输出统计信息：
  - Total instances: 5
  - Successful: 4
  - Failed: 1
  - Total cost: $3.25
  - Total time: 45m 32s
```

---

## 数据流向

### 1. 配置流

```
命令行参数
    ↓
run_secb.sh 解析
    ↓
YAML 配置文件
    ↓
RunBatchConfig 对象
    ↓
AgentConfig 对象
    ↓
Agent 实例
```

### 2. 数据流

```
SEC-bench 数据集（HuggingFace）
    ↓
BatchInstanceLoader 加载
    ↓
Instance 对象列表
    ↓
ThreadPoolExecutor 分发
    ↓
单个 Instance 处理
    ↓
Trajectory 文件（.traj）
    ↓
predictions.jsonl
```

### 3. 控制流

```
用户命令
    ↓
run_secb.sh 验证
    ↓
sweagent run-batch 启动
    ↓
RunBatchManager 调度
    ↓
Agent.run() 循环
    ↓
    ┌─────────────────┐
    │  LLM 生成动作   │←──┐
    └────────┬────────┘   │
             ↓             │
    ┌────────────────────┐│
    │  Tool 执行动作     ││
    └────────┬───────────┘│
             ↓             │
    ┌────────────────────┐│
    │  获取观察结果      ││
    └────────┬───────────┘│
             ↓             │
    ┌────────────────────┐│
    │  更新历史上下文    ││
    └────────┬───────────┘│
             └─────────────┘
             ↓
    提交结果或达到限制
```

---

## 关键配置参数

### 脚本层参数

| 参数 | 默认值 | 说明 | 影响 |
|------|--------|------|------|
| `-m MODEL` | 4o | 模型选择 | 影响性能、成本、质量 |
| `-c COST` | 1.5 | 成本限制（美元） | 防止过度消费 |
| `-e TEMP` | 0.0 | 温度 | 影响输出随机性 |
| `-l SLICE` | :80 | 实例切片 | 控制处理实例数量 |
| `-n CALLS` | 75 | 调用次数限制 | 防止无限循环 |
| `-w WORKERS` | 1 | 并行 worker | 影响处理速度 |

### 配置文件参数

| 参数 | 说明 | PoC 模式 | Patch 模式 |
|------|------|----------|------------|
| `execution_timeout` | 命令超时时间 | 300s | 300s |
| `WINDOW` | 文件窗口大小 | 100 行 | 100 行 |
| `bundles` | 工具集合 | submit_poc | submit_patch |
| `parse_function` | 动作解析器 | function_calling | function_calling |
| `history_processors` | 历史处理器 | last_n (5) | last_n (5) |

### 模型参数

| 参数 | 说明 | 默认值 | 可选值 |
|------|------|--------|--------|
| `temperature` | 采样温度 | 0.0 | 0.0-2.0 |
| `top_p` | 核采样概率 | 0.95 | 0.0-1.0 |
| `per_instance_call_limit` | 每实例调用限制 | 75 | 任意正整数 |
| `per_instance_cost_limit` | 每实例成本限制 | 1.5 | 任意正数（美元）|
| `delay` | 请求间延迟 | 1.0 | 任意正数（秒） |

---

## 工作流优化建议

### 1. 提高成功率

```bash
# 增加调用次数限制
./run_secb.sh poc -n 100

# 提高成本限制
./run_secb.sh poc -c 3.0

# 使用更强大的模型
./run_secb.sh poc -m sonnet
```

### 2. 提高处理速度

```bash
# 使用多个 worker
./run_secb.sh poc -w 4

# 只处理部分实例
./run_secb.sh poc -l :10

# 使用更快的模型
./run_secb.sh poc -m 4o
```

### 3. 降低成本

```bash
# 使用低成本模型
./run_secb.sh poc -m deepseek

# 降低成本限制
./run_secb.sh poc -c 0.5

# 减少调用次数
./run_secb.sh poc -n 30
```

### 4. 调试和开发

```bash
# 单实例测试
./run_secb.sh poc -l 0:1

# 使用人工模式
./run_secb.sh poc -m human

# 查看轨迹
sweagent inspect output_dir/instance_0.traj
```

---

## 故障排查

### 常见问题

#### 1. Docker 相关

**问题**：`Cannot connect to Docker daemon`

**解决**：
```bash
sudo systemctl start docker
sudo usermod -aG docker $USER
```

#### 2. API 相关

**问题**：`Authentication failed`

**解决**：
- 检查 `.env` 文件
- 验证 API key 有效性
- 确认 API base URL 正确

#### 3. 实例加载失败

**问题**：`No instances found`

**解决**：
- 检查 `--instances.split` 参数
- 验证数据集可访问
- 确认切片范围有效

#### 4. 提交失败

**问题**：PoC/Patch 未正确提交

**解决**：
- 检查 `/testcase` 目录内容
- 查看 submit 命令输出
- 验证提交标记格式

---

## 总结

`run_secb.sh` 通过多层架构实现了复杂的安全漏洞分析和修复流程：

1. **简化用户体验**：友好的命令行接口
2. **灵活配置**：支持多种模型和参数组合
3. **安全隔离**：Docker 容器化执行
4. **可扩展性**：模块化工具系统
5. **可观测性**：详细的轨迹记录

这种设计使得 SWE-agent 能够高效、安全地处理批量安全任务，同时保持良好的可维护性和可扩展性。

---

## 参考资料

- [SWE-agent 官方文档](https://swe-agent.com/latest/)
- [SEC-bench 数据集](https://huggingface.co/datasets/SEC-bench/SEC-bench)
- [LiteLLM 文档](https://docs.litellm.ai/docs/)
- [SWE-ReX GitHub](https://github.com/SWE-agent/SWE-ReX)
