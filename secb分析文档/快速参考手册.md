# SWE-agent 工作流快速参考

## 🚀 一分钟理解工作流

```
用户命令
    ↓
./run_secb.sh poc -m deepseek -l :5
    ↓
[脚本层] 参数解析 + 模型映射
    ↓
sweagent run-batch --config secb_poc.yaml ...
    ↓
[调度层] 加载 5 个实例 → 分配给 worker
    ↓
[执行层] 对每个实例：
    1. 创建 Docker 容器
    2. 克隆代码库
    3. Agent 循环（最多 75 次）：
       LLM 生成动作 → 执行工具 → 获取观察 → 更新上下文
    4. 提交 PoC/Patch
    5. 保存轨迹文件
    ↓
[汇总层] 合并所有结果 → predictions.jsonl
```

## 📦 核心��件

| 层次 | 组件 | 文件/模块 | 职责 |
|------|------|-----------|------|
| **脚本层** | run_secb.sh | `run_secb.sh` | 命令行接口 |
| **配置层** | YAML 配置 | `config/secb_*.yaml` | 定义 Agent 行为 |
| **调度层** | RunBatch | `sweagent/run/run_batch.py` | 批量处理调度 |
| **Agent 层** | Agent | `sweagent/agent/agents.py` | LLM 交互逻辑 |
| **工具层** | Tools | `tools/*/bin/*` | 文件操作、搜索、编辑 |
| **环境层** | SWE-ReX | Docker 容器 | 隔离执行环境 |

## 🔄 两种模式对比

### PoC 模式（生成漏洞利用代码）

```
目标：创建触发漏洞的 PoC 文件

工作流：
1. 探索代码库
2. 分析漏洞
3. 开发 PoC（Python 脚本）
4. 验证（secb repro）
5. 优化（重复 2-4）

输出：/testcase/*.py → poc.tar.gz.base64

配置：config/secb_poc.yaml
提交工具：tools/submit_poc
```

### Patch 模式（生成修复补丁）

```
目标：生成修复漏洞的代码补丁

工作流：
1. 探索代码库
2. 提出修复方案（2-3 种）
3. 实现最小化修改
4. 验证（secb build + repro）
5. 最终审查

输出：git diff → model.patch

配置：config/secb_patch.yaml
提交工具：tools/submit_patch
```

## 🛠️ 常用工具

### 文件导航（tools/defaults）
```bash
open main.c          # 打开文件
goto 100             # 跳转到第 100 行
scroll_down          # 向下滚动
create test.py       # 创建新文件
```

### 搜索（tools/search）
```bash
find_file "*.c"              # 查找 C 文件
search_dir "CVE" ./src       # 在 src 中搜索 CVE
search_file "malloc" main.c  # 在 main.c 中搜索 malloc
```

### 编辑（tools/change）
```bash
edit main.c:10-15
// 新代码
<<<<<<< DIVIDER >>>>>>>
```

### 提交
```bash
submit              # PoC 模式
submit /workspace   # Patch 模式
```

## 📊 关键参数速查

### 命令行参数

```bash
./run_secb.sh <mode> [options]

mode:
  poc      生成 PoC
  patch    生成补丁

常用选项:
  -m deepseek      使用 DeepSeek 模型
  -l :10           处理前 10 个实例
  -w 2             使用 2 个并行 worker
  -c 2.0           成本限制 $2.0
  -n 100           最多调用 100 次
```

### 模型选择

| 简称 | 完整名称 | 推荐场景 |
|------|----------|----------|
| `deepseek` | openai/deepseek-chat | 低成本、高性价比 |
| `sonnet` | claude-3-7-sonnet | 高质量、SoTA 性能 |
| `4o` | gpt-4o | 平衡性能和成本 |
| `gemini-pro` | gemini-2.5-pro | Google 生态 |

### 切片语法

```bash
-l :10      # 前 10 个（0-9）
-l 10:20    # 第 10-19 个
-l 5:6      # 单个实例（第 5 个）
-l :80      # 前 80 个（默认）
```

## 🎯 典型使用场景

### 场景 1：快速测试

```bash
# 单个实例 + DeepSeek
./run_secb.sh poc -m deepseek -l 0:1 -c 0.5

# 查看轨���
sweagent inspect trajectories/*/instance_0.traj
```

### 场景 2：小规模评估

```bash
# 前 10 个实例 + 并行处理
./run_secb.sh poc -m deepseek -l :10 -w 2 -c 1.5
```

### 场景 3：完整评估

```bash
# 所有实例 + 高并行
./run_secb.sh patch -m sonnet -l :80 -w 4 -c 3.0 -n 100
```

### 场景 4：成本优化

```bash
# 低成本设置
./run_secb.sh poc -m deepseek -c 0.3 -n 30 -l :5
```

## 🔍 调试技巧

### 1. 查看实时日志

```bash
# 运行时日志在 output_dir/
tail -f trajectories/*/instance_0.log
```

### 2. 检查容器状态

```bash
docker ps                    # 查看运行中的容器
docker logs <container_id>   # 查看容器日志
```

### 3. 检查提交内容

```bash
# PoC 模式
base64 -d poc.tar.gz.base64 > poc.tar.gz
tar -xzf poc.tar.gz

# Patch 模式
cat model.patch
```

### 4. 重放轨迹

```bash
sweagent run-replay --trajectory trajectories/*/instance_0.traj
```

## 💡 最佳实践

### ✅ DO

1. **从小规模开始**：先测试 1-5 个实例
2. **设置合理限制**：避免过度消费（-c 和 -n）
3. **使用并行处理**：多实例时用 -w 参数
4. **定期检查输出**：监控 trajectories/ 目录
5. **保存配置**：记录成功的参数组合

### ❌ DON'T

1. **不要一次性运行所有实例**（除非已充分测试）
2. **不要忽略成本限制**（可能产生高额费用）
3. **不要在生产环境无监控运行**
4. **不要忘记备份重要结果**
5. **不要混用不同版本的配置**

## 📈 性能优化

### 提高成功率
```bash
-n 100      # 增加尝试次数
-c 3.0      # 提高成本限制
-m sonnet   # 使用更强模型
```

### 提高速度
```bash
-w 4        # 增加并行度
-m 4o       # 使用更快模型
-l :10      # 减少实例数
```

### 降低成本
```bash
-m deepseek # 使用低成本模型
-c 0.5      # 降低成本限制
-n 30       # 减少尝试次数
```

## 🆘 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| `ModuleNotFoundError: docker` | 未安装 docker 模块 | `python -m pip install docker` |
| `Cannot connect to Docker daemon` | Docker 未运行 | `sudo systemctl start docker` |
| `Authentication failed` | API key 无效 | 检查 `.env` 文件 |
| `No instances found` | 数据集加载失败 | 检查网络和切片参数 |
| `Submission timeout` | 执行超时 | 增加 `execution_timeout` |

## 📚 延伸阅读

- 📖 **完整分析**：`完整工作流分析.md`（深入技术细节）
- 🔧 **配置说明**：`DeepSeek配置说明.md`（API 配置）
- 📝 **执行命令**：`执行命令.md`（命令示例）
- 🌐 **官方文档**：https://swe-agent.com/latest/

## 🎓 学习路径

```
新手：
  1. 阅读本文档
  2. 运行单个实例测试
  3. 查看轨迹文件
  ↓
进阶：
  4. 阅读完整工作流分析
  5. 自定义配置文件
  6. 实现自定义工具
  ↓
专家：
  7. 优化 Prompt 模板
  8. 扩展工具系统
  9. 集成新模型
```
