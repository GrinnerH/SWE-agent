# SWE-agent 轨迹保存机制完整分析

## 概述

**是的，SWE-agent 有完整的轨迹保存机制！** 每次运行都会自动保存详细的执行轨迹（trajectory）到 `.traj` 文件中。

## 轨迹保存机制

### 1. 自动保存触发点

轨迹在执行过程中会**自动保存多次**：

```python
# 在 sweagent/agent/agents.py 的 run() 方法中

while not step_output.done:
    step_output = self.step()
    self.save_trajectory(choose=False)  # ✅ 每步之后保存
    if step_output.done:
        self._finalize_agent_run()
        self.save_trajectory(choose=False)  # ✅ 提交后保存
        if self._rloop.retry():
            self._next_attempt()
            step_output.done = False
self.save_trajectory(choose=True)  # ✅ 最终保存
```

**保存频率**：
- ✅ **每步之后**：每次 Agent 执行一个动作后
- ✅ **提交后**：Agent 提交结果后
- ✅ **最终**：整个运行结束后

### 2. 保存位置

```
trajectories/
└── <user>__<config>__<model>__<instance_id>/
    ├── instance_id.traj              # 轨迹文件（JSON）
    ├── instance_id.trace.log         # 详细日志
    ├── instance_id.debug.log         # 调试日志
    └── instance_id.info.log          # 信息日志
```

**示例路径**：
```
trajectories/grinner/secb_poc__deepseek-chat__CVE-2021-1234/
├── CVE-2021-1234.traj
├── CVE-2021-1234.trace.log
├── CVE-2021-1234.debug.log
└── CVE-2021-1234.info.log
```

对于 `run-batch`，输出目录由以下规则决定：
```python
# 如果 output_dir 为 DEFAULT（默认）
output_dir = trajectories/<model_id>__<dataset>__<timestamp>/
```

## 轨迹文件结构

### 完整 Schema

```json
{
  "environment": "string",              // 环境类型
  "trajectory": [                       // 执行步骤列表
    {
      "action": "string",              // Agent 执行的动作
      "observation": "string",         // 环境返回的观察
      "response": "string",            // LLM 原始响应
      "state": "string",               // JSON 序列化的状态
      "thought": "string",             // Agent 的思考过程
      "execution_time": float          // 执行时间（秒）
    }
  ],
  "history": [                          // 完整对话历史
    {
      "role": "system|user|assistant", // 消息角色
      "content": "string",             // 消息内容
      "agent": "primary",              // Agent 名称
      "thought": "string",             // 思考（可选）
      "action": "string"               // 动作（可选）
    }
  ],
  "info": {                             // 元信息
    "exit_status": "string",           // 退出状态
    "submission": "string",            // 提交内容
    "model_stats": {                   // 模型统计
      "total_cost": float,             // 总成本
      "api_calls": int,                // API 调用次数
      "instance_cost": float,          // 实例成本
      "tokens_sent": int,              // 发送 token 数
      "tokens_received": int           // 接收 token 数
    },
    "swe_agent_version": "string",     // SWE-agent 版本
    "swe_agent_hash": "string",        // Git commit hash
    "swe_rex_version": "string",       // SWE-ReX 版本
    "swe_rex_hash": "string"           // SWE-ReX hash
  },
  "attempts": [                         // 多次尝试（如果有）
    {
      // 每次尝试包含完整的轨迹和历史
    }
  ]
}
```

### 核心字段说明

#### 1. **trajectory** - 执行轨迹

每个步骤包含：

```json
{
  "action": "search_file CVE main.c\n",
  "observation": "Found 3 matches in main.c:\nLine 10: CVE-2021-1234\n...",
  "response": "Let me search for CVE in main.c\n```\nsearch_file CVE main.c\n```",
  "state": "{\"open_file\": \"main.c\", \"working_dir\": \"/workspace\"}",
  "thought": "Let me search for CVE in main.c\n",
  "execution_time": 0.5
}
```

**字段解释**：
- `action`: 实际执行的 bash 命令或工具调用
- `observation`: 命令执行后的输出
- `response`: LLM 生成的完整响应（包含思考和命令）
- `state`: 环境当前状态（打开的文件、工作目录等）
- `thought`: Agent 的推理过程
- `execution_time`: 命令执行耗时

#### 2. **history** - 对话历史

完整的 LLM 对话记录：

```json
[
  {
    "role": "system",
    "content": "You are a helpful assistant...",
    "agent": "primary"
  },
  {
    "role": "user",
    "content": "{{problem_statement}}...",
    "agent": "primary"
  },
  {
    "role": "assistant",
    "content": "Let me start by exploring...",
    "thought": "Let me start by exploring...",
    "action": "ls -la",
    "agent": "primary"
  },
  {
    "role": "user",
    "content": "total 48\ndrwxr-xr-x...",
    "agent": "primary"
  }
]
```

**用途**：
- 重放对话
- 分析 Agent 决策过程
- 调试 Prompt 问题

#### 3. **info** - 元数据

```json
{
  "exit_status": "submitted",
  "submission": "<<SWE_AGENT_SUBMISSION>>base64_content<<SWE_AGENT_SUBMISSION>>",
  "model_stats": {
    "total_cost": 0.45,
    "api_calls": 23,
    "instance_cost": 0.45,
    "tokens_sent": 12543,
    "tokens_received": 3421
  },
  "swe_agent_version": "1.0.1",
  "swe_agent_hash": "7aebdce6ff41e8e6",
  "swe_rex_version": "1.4.0",
  "swe_rex_hash": "unavailable"
}
```

**用途**：
- 成本追踪
- 性能分析
- 版本管理

## 轨迹文件用途

### 1. **重放（Replay）**

```bash
# 重放轨迹文件
sweagent run-replay --trajectory trajectories/*/instance_0.traj
```

**用途**：
- 调试问题
- 验证行为
- 演示过程

### 2. **检查（Inspect）**

```bash
# 交互式查看轨迹
sweagent inspect trajectories/*/instance_0.traj
```

**功能**：
- 步进查看每个动作
- 查看完整对话历史
- 分析决策过程

### 3. **数据分析**

```python
import json

# 加载轨迹
with open("trajectory.traj") as f:
    traj = json.load(f)

# 分析统计
print(f"Total steps: {len(traj['trajectory'])}")
print(f"Total cost: ${traj['info']['model_stats']['total_cost']:.2f}")
print(f"API calls: {traj['info']['model_stats']['api_calls']}")

# 提取成功模式
successful_actions = [
    step['action'] for step in traj['trajectory']
    if 'success' in step['observation'].lower()
]
```

### 4. **训练数据**

轨迹文件可以转换为训练数据：

```bash
# 将轨迹转换为演示数据
sweagent run-traj-to-demo --trajectory path/to/trajectory.traj
```

## 批量运行的轨迹管理

### 1. **多实例轨迹**

`run-batch` 会为每个实例创建独立轨迹：

```
trajectories/
└── deepseek__secb_poc__20250127_143022/
    ├── CVE-2021-1234/
    │   ├── CVE-2021-1234.traj
    │   └── *.log
    ├── CVE-2021-5678/
    │   ├── CVE-2021-5678.traj
    │   └── *.log
    └── predictions.jsonl          # 合并的预测结果
```

### 2. **预测结果合并**

```jsonl
{"instance_id": "CVE-2021-1234", "model_patch": "...", "model_name_or_path": "deepseek-chat"}
{"instance_id": "CVE-2021-5678", "model_patch": "...", "model_name_or_path": "deepseek-chat"}
```

### 3. **自动跳过已完成实例**

```python
# 默认行为：跳过已有 .traj 文件的实例
--redo_existing=False  # 默认

# 强制重新运行
--redo_existing=True
```

## 配置轨迹保存

### 1. **输出目录配置**

```bash
# 方式 1：通过命令行
sweagent run-batch --output_dir ./my_results

# 方式 2：通过环境变量
export SWE_AGENT_OUTPUT_DIR=./my_results

# 方式 3：在配置文件中（不推荐，因为会被命令行覆盖）
# 使用默认值，自动生成目录名
```

### 2. **日志级别配置**

```python
# 在配置文件或代码中
import logging

# 设置日志级别
logging.basicConfig(level=logging.DEBUG)  # trace/debug/info

# 这会影响 .log 文件的详细程度
```

### 3. **自定义保存内容**

通过 Hook 机制可以自定义保存内容：

```python
from sweagent.run.hooks.abstract import RunHook

class CustomSaveHook(RunHook):
    def on_step(self, step_output):
        # 自定义保存逻辑
        with open("custom_log.txt", "a") as f:
            f.write(f"Step: {step_output.action}\n")
```

## 轨迹分析示例

### 示例 1：成功率分析

```python
import json
from pathlib import Path

def analyze_success_rate(output_dir):
    traj_files = list(Path(output_dir).rglob("*.traj"))

    successful = 0
    failed = 0

    for traj_file in traj_files:
        with open(traj_file) as f:
            traj = json.load(f)

        if traj['info'].get('submission'):
            successful += 1
        else:
            failed += 1

    print(f"Success Rate: {successful}/{len(traj_files)} = {successful/len(traj_files)*100:.1f}%")

analyze_success_rate("trajectories/deepseek__secb_poc__20250127/")
```

### 示例 2：成本分析

```python
def analyze_costs(output_dir):
    traj_files = list(Path(output_dir).rglob("*.traj"))

    total_cost = 0
    total_calls = 0

    for traj_file in traj_files:
        with open(traj_file) as f:
            traj = json.load(f)

        stats = traj['info'].get('model_stats', {})
        total_cost += stats.get('instance_cost', 0)
        total_calls += stats.get('api_calls', 0)

    print(f"Total Cost: ${total_cost:.2f}")
    print(f"Average Cost per Instance: ${total_cost/len(traj_files):.2f}")
    print(f"Total API Calls: {total_calls}")
    print(f"Average Calls per Instance: {total_calls/len(traj_files):.1f}")

analyze_costs("trajectories/deepseek__secb_poc__20250127/")
```

### 示例 3：工具使用分析

```python
from collections import Counter

def analyze_tool_usage(traj_file):
    with open(traj_file) as f:
        traj = json.load(f)

    commands = []
    for step in traj['trajectory']:
        action = step['action'].strip()
        cmd = action.split()[0] if action else ""
        commands.append(cmd)

    tool_usage = Counter(commands)
    print("Tool Usage:")
    for tool, count in tool_usage.most_common():
        print(f"  {tool}: {count}")

analyze_tool_usage("trajectories/*/CVE-2021-1234/CVE-2021-1234.traj")
```

## 高级功能

### 1. **差异比较**

```bash
# 比较两次运行的差异
python -m sweagent.run.compare_runs \
    --traj1 run1/instance.traj \
    --traj2 run2/instance.traj
```

### 2. **轨迹可视化**

```bash
# 使用 Web UI 可视化轨迹
sweagent inspector --trajectory trajectories/*/instance.traj

# 启动 inspector 服务器
# 访问 http://localhost:8000 查看交互式轨迹
```

### 3. **提取补丁**

```bash
# 从轨迹中提取生成的补丁
python -m sweagent.run.extract_pred \
    --traj_dir trajectories/deepseek__secb_poc/
```

### 4. **清理未完成轨迹**

```bash
# 删除未完成的轨迹（没有提交的）
python -m sweagent.run.remove_unfinished \
    --traj_dir trajectories/deepseek__secb_poc/
```

## 最佳实践

### 1. **轨迹管理**

```bash
# ✅ 使用描述性的输出目录名
./run_secb.sh poc -m deepseek -l :10 --output_dir results/experiment_1

# ✅ 定期备份重要轨迹
tar -czf trajectories_backup_$(date +%Y%m%d).tar.gz trajectories/

# ✅ 清理旧轨迹
find trajectories/ -type f -mtime +30 -name "*.traj" -delete
```

### 2. **调试工作流**

```bash
# 1. 运行单个实例
./run_secb.sh poc -m deepseek -l 0:1

# 2. 查看轨迹
sweagent inspect trajectories/*/instance_0/instance_0.traj

# 3. 如果失败，查看日志
tail -f trajectories/*/instance_0/instance_0.debug.log

# 4. 分析问题后重新运行
./run_secb.sh poc -m deepseek -l 0:1 --redo_existing=True
```

### 3. **批量分析**

```python
# 创建分析脚本 analyze_batch.py
import json
from pathlib import Path
import pandas as pd

def analyze_batch(output_dir):
    results = []

    for traj_file in Path(output_dir).rglob("*.traj"):
        with open(traj_file) as f:
            traj = json.load(f)

        results.append({
            'instance_id': traj_file.parent.name,
            'success': bool(traj['info'].get('submission')),
            'cost': traj['info']['model_stats']['instance_cost'],
            'api_calls': traj['info']['model_stats']['api_calls'],
            'steps': len(traj['trajectory'])
        })

    df = pd.DataFrame(results)
    print(df.describe())
    print(f"\nSuccess Rate: {df['success'].mean()*100:.1f}%")
    print(f"Total Cost: ${df['cost'].sum():.2f}")

    return df

# 使用
df = analyze_batch("trajectories/deepseek__secb_poc__20250127/")
df.to_csv("batch_analysis.csv", index=False)
```

## 故障排查

### 问题 1：轨迹文件不完整

**症状**：`.traj` 文件存在但内容为空或不完整

**原因**：
- 运行被中断（Ctrl+C）
- 系统崩溃
- 磁盘空间不足

**解决**：
```bash
# 删除不完整的轨迹
python -m sweagent.run.remove_unfinished --traj_dir trajectories/

# 重新运行
./run_secb.sh poc -m deepseek -l :10 --redo_existing=True
```

### 问题 2：轨迹文件过大

**症状**：`.traj` 文件达到 GB 级别

**原因**：
- 输出过多（如大文件内容）
- 循环次数过多

**解决**：
```bash
# 检查文件大小
du -sh trajectories/*/

# 压缩大轨迹文件
find trajectories/ -name "*.traj" -size +100M -exec gzip {} \;
```

### 问题 3：找不到轨迹文件

**症状**：运行完成但没有 `.traj` 文件

**检查**：
```bash
# 检查输出目录
echo $SWE_AGENT_OUTPUT_DIR

# 查找所有轨迹文件
find . -name "*.traj" -mtime -1

# 检查日志
cat *.log | grep "Saving trajectory"
```

## 总结

### ✅ SWE-agent 轨迹保存机制的优势

1. **完全自动化**：无需手动保存，每步自动记录
2. **详细完整**：包含动作、观察、思考、状态的完整记录
3. **可重放**：支持完整重放执行过程
4. **可分析**：JSON 格式易于解析和分析
5. **多实例支持**：批量运行时每个实例独立保存
6. **版本追踪**：记录 SWE-agent 和 SWE-ReX 版本信息

### 📊 典型轨迹统计

- **文件大小**：50KB - 5MB（取决于步骤数）
- **步骤数量**：10 - 100 步（平均 30-40 步）
- **对话轮次**：与步骤数相同
- **保存频率**：每步实时保存（约 1-5 秒/次）

### 🎯 使用建议

1. **开发阶段**：使用 `sweagent inspect` 交互式查看
2. **调试阶段**：查看 `.debug.log` 详细日志
3. **评估阶段**：编写脚本批量分析 `.traj` 文件
4. **生产阶段**：定期备份和清理轨迹文件

---

**轨迹文件是 SWE-agent 最有价值的输出之一**，充分利用它们可以帮助你：
- 🔍 深入理解 Agent 行为
- 🐛 快速定位和修复问题
- 📈 优化配置和 Prompt
- 📊 评估模型性能
- 🎓 学习和改进策略
