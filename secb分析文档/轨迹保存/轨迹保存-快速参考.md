# è½¨è¿¹ä¿å­˜æœºåˆ¶ - å¿«é€Ÿå‚è€ƒ

## ğŸ¯ æ ¸å¿ƒå›ç­”

**æ˜¯çš„ï¼SWE-agent æœ‰å®Œæ•´çš„è½¨è¿¹ä¿å­˜æœºåˆ¶ã€‚**

- âœ… **è‡ªåŠ¨ä¿å­˜**ï¼šæ¯æ­¥æ‰§è¡Œåè‡ªåŠ¨ä¿å­˜
- âœ… **å®Œæ•´è®°å½•**ï¼šåŒ…å«åŠ¨ä½œã€è§‚å¯Ÿã€æ€è€ƒã€å¯¹è¯å†å²
- âœ… **JSON æ ¼å¼**ï¼š`.traj` æ–‡ä»¶ï¼Œæ˜“äºè§£æ
- âœ… **å¤šæ—¥å¿—**ï¼š`.trace.log`, `.debug.log`, `.info.log`
- âœ… **å¯é‡æ”¾**ï¼š`sweagent run-replay`
- âœ… **å¯æ£€æŸ¥**ï¼š`sweagent inspect`

## ğŸ“ æ–‡ä»¶ç»“æ„

```
trajectories/
â””â”€â”€ <model>__<dataset>__<timestamp>/
    â”œâ”€â”€ instance_1/
    â”‚   â”œâ”€â”€ instance_1.traj          â­ ä¸»è½¨è¿¹æ–‡ä»¶
    â”‚   â”œâ”€â”€ instance_1.trace.log     ğŸ“ è¯¦ç»†æ—¥å¿—
    â”‚   â”œâ”€â”€ instance_1.debug.log     ğŸ› è°ƒè¯•æ—¥å¿—
    â”‚   â””â”€â”€ instance_1.info.log      â„¹ï¸  ä¿¡æ¯æ—¥å¿—
    â”œâ”€â”€ instance_2/
    â”‚   â””â”€â”€ ...
    â””â”€â”€ predictions.jsonl            ğŸ“Š åˆå¹¶ç»“æœ
```

## ğŸ“„ è½¨è¿¹æ–‡ä»¶å†…å®¹

```json
{
  "trajectory": [                    // æ‰§è¡Œæ­¥éª¤
    {
      "action": "search_file CVE",  // æ‰§è¡Œçš„å‘½ä»¤
      "observation": "Found 3...",   // å‘½ä»¤è¾“å‡º
      "response": "Let me search",   // LLM å®Œæ•´å“åº”
      "state": "{...}",              // ç¯å¢ƒçŠ¶æ€
      "thought": "Let me...",        // æ¨ç†è¿‡ç¨‹
      "execution_time": 0.5          // æ‰§è¡Œæ—¶é—´
    }
  ],
  "history": [                       // å®Œæ•´å¯¹è¯
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."}
  ],
  "info": {                          // å…ƒä¿¡æ¯
    "exit_status": "submitted",
    "submission": "base64...",
    "model_stats": {
      "total_cost": 0.45,
      "api_calls": 23,
      "tokens_sent": 12543
    }
  }
}
```

## ğŸ”„ ä¿å­˜æ—¶æœº

```
Agent.run()
    â”‚
    â”œâ”€> step 1 â”€â”€> save_trajectory() âœ…
    â”œâ”€> step 2 â”€â”€> save_trajectory() âœ…
    â”œâ”€> step 3 â”€â”€> save_trajectory() âœ…
    â”‚   ...
    â”œâ”€> submit â”€â”€> save_trajectory() âœ…
    â””â”€> done â”€â”€â”€â”€> save_trajectory() âœ… (æœ€ç»ˆ)
```

**ä¿å­˜é¢‘ç‡**: æ¯ä¸ªæ­¥éª¤å + æäº¤å + æœ€ç»ˆ

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹è½¨è¿¹

```bash
# äº¤äº’å¼æ£€æŸ¥
sweagent inspect trajectories/*/instance_0/instance_0.traj

# é‡æ”¾è½¨è¿¹
sweagent run-replay --trajectory path/to/instance.traj

# æŸ¥çœ‹ JSON å†…å®¹
cat trajectories/*/instance_0/instance_0.traj | jq .

# æŸ¥çœ‹æ—¥å¿—
tail -f trajectories/*/instance_0/instance_0.debug.log
```

### åˆ†æè½¨è¿¹

```python
import json

# è¯»å–è½¨è¿¹
with open("instance.traj") as f:
    traj = json.load(f)

# åŸºæœ¬ç»Ÿè®¡
print(f"Steps: {len(traj['trajectory'])}")
print(f"Cost: ${traj['info']['model_stats']['total_cost']}")
print(f"Calls: {traj['info']['model_stats']['api_calls']}")

# æå–æ‰€æœ‰åŠ¨ä½œ
actions = [step['action'] for step in traj['trajectory']]
```

### æ‰¹é‡åˆ†æ

```bash
# æŸ¥æ‰¾æ‰€æœ‰è½¨è¿¹
find trajectories/ -name "*.traj"

# ç»Ÿè®¡æˆåŠŸæ•°é‡
grep -l '"submission"' trajectories/*/*.traj | wc -l

# è®¡ç®—æ€»æˆæœ¬
find trajectories/ -name "*.traj" -exec jq -r '.info.model_stats.total_cost' {} \; | awk '{s+=$1} END {print s}'
```

## ğŸ“Š å…¸å‹è½¨è¿¹ç¤ºä¾‹

### PoC æ¨¡å¼è½¨è¿¹

```
æ­¥éª¤æ•°ï¼š35 æ­¥
æ–‡ä»¶å¤§å°ï¼š850 KB
æ‰§è¡Œæ—¶é—´ï¼š12 åˆ†é’Ÿ
æˆæœ¬ï¼š$0.35
ä¸»è¦å·¥å…·ï¼šsearch_file (12x), edit (8x), bash (15x)
ç»“æœï¼šæˆåŠŸæäº¤ PoC
```

### Patch æ¨¡å¼è½¨è¿¹

```
æ­¥éª¤æ•°ï¼š42 æ­¥
æ–‡ä»¶å¤§å°ï¼š1.2 MB
æ‰§è¡Œæ—¶é—´ï¼š15 åˆ†é’Ÿ
æˆæœ¬ï¼š$0.48
ä¸»è¦å·¥å…·ï¼šsearch_file (15x), edit (12x), bash (15x)
ç»“æœï¼šæˆåŠŸç”Ÿæˆè¡¥ä¸
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè°ƒè¯•å¤±è´¥

```bash
# 1. æŸ¥çœ‹æœ€åçš„åŠ¨ä½œ
jq '.trajectory[-5:]' instance.traj

# 2. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
grep -i "error" instance.debug.log

# 3. é‡æ”¾åˆ°å¤±è´¥ç‚¹
sweagent run-replay --trajectory instance.traj
```

### åœºæ™¯ 2ï¼šåˆ†ææˆåŠŸç­–ç•¥

```python
# æå–æˆåŠŸå®ä¾‹çš„åŠ¨ä½œåºåˆ—
successful_actions = []
for traj_file in Path("trajectories").rglob("*.traj"):
    with open(traj_file) as f:
        traj = json.load(f)
    if traj['info'].get('submission'):
        actions = [s['action'].split()[0] for s in traj['trajectory']]
        successful_actions.append(actions)

# åˆ†æå¸¸è§æ¨¡å¼
from collections import Counter
all_actions = [a for seq in successful_actions for a in seq]
print(Counter(all_actions).most_common(10))
```

### åœºæ™¯ 3ï¼šæˆæœ¬ä¼˜åŒ–

```python
# æ‰¾å‡ºé«˜æˆæœ¬æ­¥éª¤
high_cost_instances = []
for traj_file in Path("trajectories").rglob("*.traj"):
    with open(traj_file) as f:
        traj = json.load(f)
    cost = traj['info']['model_stats']['total_cost']
    steps = len(traj['trajectory'])
    if cost > 1.0:
        high_cost_instances.append({
            'file': traj_file.name,
            'cost': cost,
            'steps': steps,
            'cost_per_step': cost/steps
        })

# æ’åºå¹¶åˆ†æ
high_cost_instances.sort(key=lambda x: x['cost'], reverse=True)
```

## âš™ï¸ é…ç½®é€‰é¡¹

### è¾“å‡ºç›®å½•

```bash
# é»˜è®¤ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
./run_secb.sh poc -m deepseek -l :10
# â†’ trajectories/deepseek__secb_poc__20250127_143022/

# è‡ªå®šä¹‰
./run_secb.sh poc -m deepseek -l :10 --output_dir ./my_results/
# â†’ my_results/

# é€šè¿‡ç¯å¢ƒå˜é‡
export SWE_AGENT_OUTPUT_DIR=./my_results
```

### è·³è¿‡å·²å®Œæˆå®ä¾‹

```bash
# é»˜è®¤ï¼šè·³è¿‡å·²æœ‰è½¨è¿¹çš„å®ä¾‹
./run_secb.sh poc -m deepseek -l :10

# å¼ºåˆ¶é‡æ–°è¿è¡Œ
./run_secb.sh poc -m deepseek -l :10 --redo_existing=True
```

## ğŸ”§ å®ç”¨å·¥å…·

### è½¨è¿¹ç»Ÿè®¡è„šæœ¬

```bash
#!/bin/bash
# traj_stats.sh - è½¨è¿¹ç»Ÿè®¡å·¥å…·

TRAJ_DIR=$1

echo "=== Trajectory Statistics ==="
echo "Total trajectories: $(find $TRAJ_DIR -name "*.traj" | wc -l)"
echo "Successful: $(grep -l '"submission"' $TRAJ_DIR/*/*.traj 2>/dev/null | wc -l)"
echo "Total cost: $(find $TRAJ_DIR -name "*.traj" -exec jq -r '.info.model_stats.total_cost // 0' {} \; | awk '{s+=$1} END {print "$" s}')"
echo "Total steps: $(find $TRAJ_DIR -name "*.traj" -exec jq '.trajectory | length' {} \; | awk '{s+=$1} END {print s}')"
```

ä½¿ç”¨ï¼š
```bash
chmod +x traj_stats.sh
./traj_stats.sh trajectories/deepseek__secb_poc__20250127/
```

### Python åˆ†æåº“

```python
# traj_analyzer.py
import json
from pathlib import Path
from dataclasses import dataclass
from typing import List

@dataclass
class TrajectoryStats:
    instance_id: str
    steps: int
    cost: float
    api_calls: int
    success: bool
    execution_time: float

class TrajectoryAnalyzer:
    def __init__(self, traj_dir: str):
        self.traj_dir = Path(traj_dir)

    def load_all(self) -> List[TrajectoryStats]:
        stats = []
        for traj_file in self.traj_dir.rglob("*.traj"):
            with open(traj_file) as f:
                traj = json.load(f)

            total_time = sum(s['execution_time'] for s in traj['trajectory'])
            stats.append(TrajectoryStats(
                instance_id=traj_file.parent.name,
                steps=len(traj['trajectory']),
                cost=traj['info']['model_stats']['total_cost'],
                api_calls=traj['info']['model_stats']['api_calls'],
                success=bool(traj['info'].get('submission')),
                execution_time=total_time
            ))
        return stats

    def summary(self):
        stats = self.load_all()
        print(f"Total Instances: {len(stats)}")
        print(f"Success Rate: {sum(s.success for s in stats)/len(stats)*100:.1f}%")
        print(f"Total Cost: ${sum(s.cost for s in stats):.2f}")
        print(f"Avg Steps: {sum(s.steps for s in stats)/len(stats):.1f}")
        print(f"Avg Time: {sum(s.execution_time for s in stats)/len(stats)/60:.1f} min")

# ä½¿ç”¨
analyzer = TrajectoryAnalyzer("trajectories/deepseek__secb_poc__20250127/")
analyzer.summary()
```

## ğŸ“š å»¶ä¼¸é˜…è¯»

- ğŸ“– **è¯¦ç»†æ–‡æ¡£**: `è½¨è¿¹ä¿å­˜æœºåˆ¶.md`ï¼ˆ14000+ å­—å®Œæ•´åˆ†æï¼‰
- ğŸš€ **å¿«é€Ÿå‚è€ƒ**: `å¿«é€Ÿå‚è€ƒæ‰‹å†Œ.md`ï¼ˆå¸¸ç”¨å‘½ä»¤é€ŸæŸ¥ï¼‰
- ğŸ” **å·¥ä½œæµåˆ†æ**: `å®Œæ•´å·¥ä½œæµåˆ†æ.md`ï¼ˆç«¯åˆ°ç«¯æµç¨‹ï¼‰

## ğŸ’¡ å…³é”®è¦ç‚¹

1. âœ… **è‡ªåŠ¨ä¿å­˜**ï¼šæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼Œå®Œå…¨è‡ªåŠ¨åŒ–
2. ğŸ“ **å®Œæ•´è®°å½•**ï¼šåŠ¨ä½œã€è§‚å¯Ÿã€æ€è€ƒã€å¯¹è¯å…¨è®°å½•
3. ğŸ”„ **å¯é‡æ”¾**ï¼šæ”¯æŒå®Œæ•´é‡æ”¾è°ƒè¯•
4. ğŸ“Š **æ˜“åˆ†æ**ï¼šJSON æ ¼å¼ï¼Œæ˜“äºç¼–ç¨‹å¤„ç†
5. ğŸ’¾ **å¤šå®ä¾‹**ï¼šæ‰¹é‡è¿è¡Œæ¯ä¸ªç‹¬ç«‹ä¿å­˜
6. ğŸ¯ **å¤šç”¨é€”**ï¼šè°ƒè¯•ã€åˆ†æã€è®­ç»ƒã€æ¼”ç¤º

---

**è½¨è¿¹æ–‡ä»¶æ˜¯ç†è§£å’Œä¼˜åŒ– SWE-agent çš„å…³é”®ï¼** å……åˆ†åˆ©ç”¨å®ƒä»¬ï¼
